name: Auto-generate and upload routes

on:
  push:
    branches: [ master ]
  
  workflow_dispatch:

  schedule:
    - cron: '10 19 * * *'

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Create dist folder
      run: mkdir -p dist

    - name: Build nchnroutes
      env: 
        PASS_IPS: ${{secrets.PASS_IPS}}
      run: |
        CURRENT_DIR=$(pwd)
        cd dist
        make

    - name: chang v6 gateway
      run: |
        sed -i 's/192\.168\.2\.99/fd50:3b21:db2::1/g' ./routes6.conf
        cd $CURRENT_DIR

    - name: Set env variables
      run: |
        echo "RELEASE_NAME=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "TAG_NAME=$(date +%Y%m%d)" >> $GITHUB_ENV
      shell: bash

    - name: Push to release branch
      run: |
        mkdir publish
        cp -af dist/route4.conf publish/route4.conf
        cp -af dist/route6.conf publish/route6.conf
        cd publish
        git init
        git config --local user.name "${{ github.actor }}"
        git config --local user.email "${{ github.actor }}@users.noreply.github.com"
        git checkout -b release
        git add .
        git commit -m "${{ env.RELEASE_NAME }}"
        git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
        git push -f -u origin release
